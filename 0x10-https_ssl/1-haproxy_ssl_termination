global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # Default SSL material locations
    ca-base /etc/ssl/certs
    crt-base /etc/ssl/private

    # Default ciphers to use on SSL-enabled listening sockets.
    ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS
    ssl-default-bind-options no-sslv3

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5000
    timeout client 50000
    timeout server 50000
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# The frontend only listens on port 80
# If it detects a LetsEncrypt request, it uses the LE backend
# Else it goes to the default backend for the web servers
frontend http
    bind *:80

    # This is our new config that listens on port 443 for SSL connections
    bind *:443 ssl crt /etc/ssl/www.teflondev.tech/www.teflondev.tech.pem

    # Test URI to see if it's a Let's Encrypt request
    acl letsencrypt-acl path_beg /.well-known/acme-challenge/
    use_backend letsencrypt-backend if letsencrypt-acl

    mode http
    default_backend web-backend

# LE Backend
backend letsencrypt-backend
    server letsencrypt 127.0.0.1:8888

# Normal (default) Backend
# for web apps
backend web-backend
    balance roundrobin
    server web-01 54.144.20.75:80 check
    server web-02 100.26.151.157:80 check

# SSL Termination Configuration
frontend https
    bind *:443 ssl crt /etc/ssl/www.teflondev.tech/www.teflondev.tech.pem
    mode http
    default_backend web-backend

# Ensure the root of the domain returns "Holberton School"
backend web-backend
    balance roundrobin
    server web-01 54.144.20.75:80 check
    server web-02 100.26.151.157:80 check
    http-request set-header Host www.teflondev.tech
    http-response set-header Server HAProxy
    http-response set-header Content-Length 19
    http-response set-header Content-Type text/html
    http-response set-header Cache-Control no-cache
    http-response set-header Connection keep-alive
    http-response set-header Accept-Ranges bytes
    http-response set-header Vary Accept-Encoding
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection 1; mode=block
    http-response set-header Strict-Transport-Security max-age=31536000; includeSubDomains; preload
    http-response set-header Referrer-Policy same-origin
    http-response set-header X-Frame-Options DENY
    http-response set-header X-UA-Compatible IE=edge,chrome=1
    http-response set-header Feature-Policy accelerometer 'none'; camera 'none'; geolocation 'none'; gyroscope 'none'; magnetometer 'none'; microphone 'none'; payment 'none'; usb 'none'
    http-response set-header Content-Security-Policy default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self'; media-src 'self'; object-src 'none'; frame-ancestors 'none'; form-action 'self'; upgrade-insecure-requests; block-all-mixed-content
    http-response set-header X-Permitted-Cross-Domain-Policies none
    http-response set-header X-Content-Security-Policy default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self'; media-src 'self'; object-src 'none'; frame-ancestors 'none'; form-action 'self'; upgrade-insecure-requests; block-all-mixed-content
